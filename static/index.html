<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Surat AI Smart Parking | Real-Time Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
      #map {
        height: 100vh;
        width: 100%;
        z-index: 1;
      }
      .glass {
        background: rgba(15, 23, 42, 0.9);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .pulse {
        animation: pulse-animation 2s infinite;
      }
      @keyframes pulse-animation {
        0% {
          transform: scale(0.95);
          box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
        }
        70% {
          transform: scale(1);
          box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
        }
        100% {
          transform: scale(0.95);
          box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
        }
      }
      .custom-slider::-webkit-slider-thumb {
        appearance: none;
        width: 18px;
        height: 18px;
        background: #3b82f6;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid white;
      }
      /* Removes the "Leaflet" text logo from the map corner */
      .leaflet-control-attribution {
        display: none !important;
      }
    </style>
  </head>
  <body class="bg-slate-950 text-white overflow-hidden font-sans">
    <div
      class="fixed top-4 right-4 z-[1000] flex items-center gap-3 px-4 py-2 rounded-full glass shadow-2xl"
    >
      <div class="w-2 h-2 rounded-full bg-green-500 pulse"></div>
      <span
        class="text-[10px] font-bold tracking-widest uppercase text-green-400"
        >SMC-ICCC Live Feed</span
      >
    </div>

    <div
      class="fixed top-0 left-0 h-full w-[420px] z-[1000] p-6 pointer-events-none flex flex-col gap-4"
    >
      <div
        class="glass h-full w-full rounded-3xl p-6 flex flex-col pointer-events-auto shadow-2xl border-blue-500/20"
      >
        <div class="mb-8">
          <h1
            class="text-xl font-black tracking-tighter text-blue-400 leading-none"
          >
            SURAT PARKING.AI
          </h1>
          <p class="text-[9px] text-slate-400 mt-1 uppercase tracking-widest">
            Smart City Analytics Engine
          </p>
        </div>

        <div class="mb-8 p-5 bg-slate-900/50 rounded-2xl border border-white/5">
          <label
            class="text-[10px] font-bold text-slate-400 uppercase tracking-wider block mb-4"
            >AI Temporal Forecasting</label
          >
          <input
            type="range"
            id="time-slider"
            min="0"
            max="23"
            value="12"
            class="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer custom-slider"
            oninput="updatePredictions()"
          />
          <div
            class="flex justify-between text-[10px] mt-2 text-slate-500 font-mono"
          >
            <span>00:00</span>
            <span
              id="current-slider-time"
              class="text-blue-400 font-bold text-lg"
              >12:00</span
            >
            <span>23:59</span>
          </div>
        </div>

        <div id="info-panel" class="flex-grow space-y-4 overflow-y-auto pr-2">
          <div class="text-center py-10">
            <p class="text-slate-500 text-xs italic">
              Select a parking zone on the map for analytics.
            </p>
          </div>
        </div>

        <div class="mt-auto pt-6 border-t border-white/10">
          <div class="flex gap-2">
            <input
              id="chat-input"
              type="text"
              placeholder="Ask AI for best route..."
              class="w-full bg-slate-800/80 border border-slate-700 rounded-xl p-3 text-xs focus:outline-none focus:border-blue-500"
            />
            <button
              onclick="askAI()"
              class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-xl transition-colors"
            >
              ðŸš€
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="map"></div>

    <script>
      const map = L.map("map", {
        zoomControl: false,
        attributionControl: false,
      }).setView([21.1702, 72.8311], 13);

      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
      ).addTo(map);

      let markers = [];

      async function updatePredictions() {
        const timeVal = document.getElementById("time-slider").value;
        document.getElementById("current-slider-time").innerText =
          `${timeVal.padStart(2, "0")}:00`;

        try {
          const res = await fetch(`/api/predict?target_hour=${timeVal}`);
          const data = await res.json();

          markers.forEach((m) => map.removeLayer(m));
          markers = [];

          data.forEach((site) => {
            const color =
              site.availability > 70
                ? "#22c55e"
                : site.availability > 30
                  ? "#f59e0b"
                  : "#ef4444";
            const circle = L.circle([site.lat, site.lng], {
              color: color,
              fillColor: color,
              fillOpacity: 0.6,
              radius: 120,
              weight: 2,
            }).addTo(map);

            circle.on("click", () => {
              document.getElementById("info-panel").innerHTML = `
                <div class="bg-blue-600/10 border border-blue-500/30 rounded-2xl p-5 shadow-xl">
                  <h2 class="text-sm font-black text-white uppercase tracking-tight">${site.name}</h2>
                  <p class="text-[10px] text-slate-400 mt-1">${site.address || "Surat, Gujarat"}</p>
                  <div class="grid grid-cols-2 gap-4 mt-6">
                    <div>
                      <p class="text-[9px] text-slate-500 uppercase font-bold tracking-tighter">Availability</p>
                      <p class="text-3xl font-black text-blue-400">${site.availability}%</p>
                    </div>
                    <div class="text-right">
                      <p class="text-[9px] text-slate-500 uppercase font-bold tracking-tighter">AI Confidence</p>
                      <p class="text-xl font-bold text-green-400">${site.confidence}%</p>
                    </div>
                  </div>
                  <div class="mt-4 p-3 bg-slate-900/80 rounded-xl border border-white/5">
                    <div class="flex justify-between text-[10px]">
                      <span class="text-slate-400">Total Capacity:</span>
                      <span class="text-white font-mono">${site.total_slots} Slots</span>
                    </div>
                  </div>
                  <div class="mt-6 pt-4 border-t border-white/5 flex justify-between items-center text-[10px]">
                    <span class="text-slate-400 italic font-mono uppercase">${site.last_updated}</span>
                  </div>
                </div>
              `;
            });
            markers.push(circle);
          });
        } catch (err) {
          console.error("Sync error:", err);
        }
      }

      setInterval(updatePredictions, 5000);

      async function askAI() {
        const input = document.getElementById("chat-input");
        if (!input.value) return;
        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query: input.value }),
        });
        const data = await res.json();
        const chatBox = `
          <div class="bg-slate-800 p-4 rounded-2xl border border-slate-700 border-l-4 border-l-blue-500">
            <p class="text-[10px] text-blue-400 font-bold uppercase mb-2">AI Recommendation</p>
            <p class="text-xs text-slate-200">${data.reply}</p>
          </div>`;
        document.getElementById("info-panel").innerHTML =
          chatBox + document.getElementById("info-panel").innerHTML;
        input.value = "";
      }

      updatePredictions();
    </script>
  </body>
</html>
