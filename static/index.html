<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Smart Parking Predictor | Near Real-Time</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
      #map {
        height: 100vh;
        width: 100%;
        z-index: 1;
      }
      .glass {
        background: rgba(15, 23, 42, 0.85);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .pulse {
        animation: pulse-animation 2s infinite;
      }
      @keyframes pulse-animation {
        0% {
          transform: scale(0.95);
          box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
        }
        70% {
          transform: scale(1);
          box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
        }
        100% {
          transform: scale(0.95);
          box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
        }
      }
    </style>
  </head>
  <body class="bg-slate-950 text-white overflow-hidden font-sans">
    <div
      class="fixed top-4 right-4 z-[1000] flex items-center gap-3 px-4 py-2 rounded-full glass shadow-2xl"
    >
      <div class="w-2 h-2 rounded-full bg-green-500 pulse"></div>
      <span class="text-[10px] font-bold tracking-widest uppercase"
        >Near Real-Time Stream Active</span
      >
    </div>

    <div
      class="fixed top-0 left-0 h-full w-[400px] z-[1000] p-6 pointer-events-none flex flex-col gap-4"
    >
      <div
        class="glass h-full w-full rounded-3xl p-6 flex flex-col pointer-events-auto shadow-2xl border-blue-500/20"
      >
        <div class="flex items-center gap-3 mb-8">
          <div class="bg-blue-600 p-2 rounded-xl shadow-lg shadow-blue-500/50">
            üÖøÔ∏è
          </div>
          <div>
            <h1
              class="text-xl font-black tracking-tighter text-blue-400 leading-none"
            >
              PARKING.AI
            </h1>
            <p class="text-[9px] text-slate-400 mt-1 uppercase tracking-widest">
              Smart City Analytics Engine
            </p>
          </div>
        </div>

        <div class="mb-8 p-4 bg-slate-900/50 rounded-2xl border border-white/5">
          <label
            class="text-[10px] font-bold text-slate-400 uppercase tracking-wider block mb-4"
            >Time-of-Day Forecast</label
          >
          <input
            type="range"
            id="time-slider"
            min="0"
            max="23"
            value="12"
            class="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
            oninput="updatePredictions()"
          />
          <div
            class="flex justify-between text-[10px] mt-2 text-slate-500 font-mono"
          >
            <span>00:00</span>
            <span id="current-slider-time" class="text-blue-400 font-bold"
              >12:00</span
            >
            <span>23:59</span>
          </div>
        </div>

        <div id="info-panel" class="flex-grow space-y-4">
          <div class="text-center py-10">
            <p class="text-slate-500 text-xs italic">
              Select a zone on the map to analyze AI confidence levels and
              demand surges.
            </p>
          </div>
        </div>

        <div class="mt-auto pt-6 border-t border-white/10">
          <div class="flex gap-2">
            <input
              id="chat-input"
              type="text"
              placeholder="Ask AI: e.g. Where is the lowest congestion?"
              class="w-full bg-slate-800/80 border border-slate-700 rounded-xl p-3 text-xs focus:outline-none focus:border-blue-500 transition-all"
            />
            <button
              onclick="askAI()"
              class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-xl transition-colors"
            >
              üöÄ
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="map"></div>

    <script>
      // 1. Initialize Geospatial Environment (Centered on Ahmedabad)
      const map = L.map("map", { zoomControl: false }).setView(
        [23.0225, 72.5714],
        13,
      );

      // Use Dark Matter tiles for professional "Smart City" aesthetic
      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
      ).addTo(map);

      let markers = [];

      // 2. Prediction Engine Interface
      async function updatePredictions() {
        const timeVal = document.getElementById("time-slider").value;
        document.getElementById("current-slider-time").innerText =
          `${timeVal.padStart(2, "0")}:00`;

        const res = await fetch(`/api/predict?target_hour=${timeVal}`);
        const zones = await res.json();

        // Clear old layers
        markers.forEach((m) => map.removeLayer(m));
        markers = [];

        zones.forEach((zone) => {
          // Color coding based on availability
          const color =
            zone.availability > 70
              ? "#22c55e"
              : zone.availability > 30
                ? "#f59e0b"
                : "#ef4444";

          const circle = L.circle([zone.lat, zone.lng], {
            color: color,
            fillColor: color,
            fillOpacity: 0.5,
            radius: 450,
            weight: 2,
          }).addTo(map);

          // OnClick: Detail extraction including Confidence Levels
          circle.on("click", () => {
            document.getElementById("info-panel").innerHTML = `
                        <div class="bg-blue-600/10 border border-blue-500/30 rounded-2xl p-5 shadow-xl">
                            <h2 class="text-lg font-black text-white">${zone.name}</h2>
                            <div class="grid grid-cols-2 gap-4 mt-6">
                                <div>
                                    <p class="text-[9px] text-slate-500 uppercase font-bold tracking-tighter">Availability</p>
                                    <p class="text-3xl font-black text-blue-400">${zone.availability}%</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-[9px] text-slate-500 uppercase font-bold tracking-tighter">AI Confidence</p>
                                    <p class="text-xl font-bold text-green-400">${zone.confidence}%</p>
                                </div>
                            </div>
                            <div class="mt-6 pt-4 border-t border-white/5 flex justify-between items-center text-[10px]">
                                <span class="text-slate-400 italic">Trend: <b class="text-white capitalize">${zone.trend}</b></span>
                                <span class="text-slate-500 font-mono">Updated: ${zone.last_updated}</span>
                            </div>
                        </div>
                    `;
          });
          markers.push(circle);
        });
      }

      // 3. Near Real-Time Polling Logic
      setInterval(async () => {
        await updatePredictions();
        console.log("Stream Sync: " + new Date().toLocaleTimeString());
      }, 5000); // 5-second frequency ensures "near real-time" accuracy

      // 4. Decision Support Chat (Simulated RAG)
      async function askAI() {
        const input = document.getElementById("chat-input");
        if (!input.value) return;

        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query: input.value }),
        });
        const data = await res.json();

        document.getElementById("info-panel").innerHTML =
          `
                <div class="bg-slate-800 p-4 rounded-2xl border border-slate-700 animate-pulse">
                    <p class="text-[10px] text-blue-400 font-bold uppercase mb-2">AI Recommendation</p>
                    <p class="text-xs leading-relaxed text-slate-200">${data.reply}</p>
                </div>
            ` + document.getElementById("info-panel").innerHTML;
        input.value = "";
      }

      // Initial Load
      updatePredictions();
    </script>
  </body>
</html>
