<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SINPA | High Contrast Digital Twin</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      #map {
        height: 100vh;
        width: 100%;
        z-index: 1;
      }
      .sidebar {
        height: 100vh;
        overflow-y: auto;
        background: #ffffff;
        border-right: 1px solid #e2e8f0;
      }
      .glass {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(8px);
      }
      ::-webkit-scrollbar {
        width: 5px;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
      }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-900 overflow-hidden">
    <div class="flex flex-col md:flex-row">
      <div class="w-full md:w-96 sidebar flex flex-col z-10 shadow-lg">
        <div class="p-6 border-b border-slate-200">
          <div class="flex items-center gap-3 mb-6">
            <div
              class="bg-red-600 px-2 py-1 rounded font-black text-white text-xs uppercase"
            >
              SINPA
            </div>
            <h1 class="text-lg font-bold tracking-tight text-slate-900">
              Smart Parking Assistant
            </h1>
          </div>
          <input
            type="text"
            id="searchInput"
            oninput="filterList()"
            placeholder="Search Local / Press ENTER for Global..."
            class="w-full bg-slate-100 border border-slate-300 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-red-500 outline-none text-slate-900 transition-all"
          />
        </div>

        <div class="p-5 bg-blue-50 border-b border-blue-100">
          <div class="flex justify-between items-center mb-2">
            <span
              class="text-[10px] font-bold text-blue-600 uppercase tracking-widest"
              >Live Feed</span
            >
            <span
              class="w-2 h-2 bg-green-500 rounded-full animate-pulse"
            ></span>
          </div>
          <div class="flex justify-between items-end">
            <h2 id="ai-slots" class="text-4xl font-black text-slate-900">
              --%
            </h2>
            <p id="ai-conf" class="text-xs font-mono text-blue-600">--% CONF</p>
          </div>
        </div>

        <div id="carpark-list" class="flex-1"></div>
      </div>

      <div class="flex-1 relative">
        <div id="map"></div>
        <div
          class="absolute bottom-6 right-6 z-[1000] glass p-4 rounded-2xl border border-slate-200 shadow-xl"
        >
          <p
            class="text-[10px] text-slate-500 uppercase font-bold tracking-widest"
          >
            System Status
          </p>
          <p class="text-xl font-black text-green-600 uppercase">Operational</p>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
      // Use Light Mode Tiles
      const map = L.map("map", { zoomControl: false }).setView(
        [1.3521, 103.8198],
        12,
      );
      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
        {
          attribution: "&copy; OpenStreetMap",
        },
      ).addTo(map);

      let markers = L.layerGroup().addTo(map);

      async function refreshData() {
        try {
          const res = await fetch("/api/map_data");
          const data = await res.json();
          const listContainer = document.getElementById("carpark-list");
          listContainer.innerHTML = "";
          markers.clearLayers();

          document.getElementById("ai-slots").innerText =
            data[0].availability + "%";
          document.getElementById("ai-conf").innerText =
            data[0].confidence + "% CONF";

          data.forEach((item, index) => {
            const color =
              item.availability > 40 ? "text-green-600" : "text-red-600";
            const mColor = item.availability > 40 ? "#16a34a" : "#dc2626";

            const card = document.createElement("div");
            card.className = `carpark-item p-5 border-b border-slate-100 hover:bg-slate-50 cursor-pointer transition-all ${index === 0 ? "bg-blue-50/50" : ""}`;
            card.onclick = () => map.flyTo([item.lat, item.lng], 16);
            card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="text-sm font-bold text-slate-900">${item.name}</h4>
                                <p class="text-[10px] text-slate-500 mt-1 uppercase">${item.status}</p>
                            </div>
                            <div class="bg-white px-2 py-1 rounded border border-slate-200 shadow-sm">
                                <span class="text-xs font-black ${color}">${item.availability}%</span>
                            </div>
                        </div>`;
            listContainer.appendChild(card);
            L.circleMarker([item.lat, item.lng], {
              radius: 7,
              fillColor: mColor,
              color: "#fff",
              weight: 2,
              fillOpacity: 0.9,
            }).addTo(markers);
          });
          filterList();
        } catch (e) {
          console.error(e);
        }
      }

      function filterList() {
        const query = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const cards = document.getElementsByClassName("carpark-item");
        Array.from(cards).forEach((card) => {
          card.style.display = card.innerText.toLowerCase().includes(query)
            ? "block"
            : "none";
        });
      }

      // Global Search Logic (Enter key)
      document
        .getElementById("searchInput")
        .addEventListener("keypress", async function (e) {
          if (e.key === "Enter") {
            const query = this.value;
            const response = await fetch(
              `https://nominatim.openstreetmap.org/search?format=json&q=${query}`,
            );
            const results = await response.json();
            if (results.length > 0) {
              map.flyTo([results[0].lat, results[0].lon], 12);
            }
          }
        });

      setInterval(refreshData, 5000);
      refreshData();
    </script>
  </body>
</html>
